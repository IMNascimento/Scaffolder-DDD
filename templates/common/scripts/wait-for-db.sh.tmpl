#!/usr/bin/env bash
set -e

echo "⏳ Aguardando banco de dados..."

until python - <<'PY'
import asyncio, os, sys
try:
    import sqlalchemy as sa
    from sqlalchemy.ext.asyncio import create_async_engine
    url = os.getenv('DATABASE_URL', '')
    async def ping():
        e = create_async_engine(url)
        async with e.connect() as c:
            await c.execute(sa.text('SELECT 1'))
        await e.dispose()
    asyncio.run(ping())
except Exception as ex:
    print(f"Erro: {ex}")
    sys.exit(1)
PY
do
    echo "⏳ Banco ainda não está pronto, aguardando..."
    sleep 2
done

echo "✅ Banco de dados pronto!"
